# Profile the already-fitted Outcomes model (RQ 3.3), Poisson with nAGQ = 1

library(lme4)       # mixed models
library(readr)      # reading in the data

m1a = readRDS("m1a-outcomes-primary-poisson-nAGQ1.rds")

print("starting model profiling...")

start.time = Sys.time()

p1a = profile(m1a,devtol=1e-07, verbose=TRUE)

end.time = Sys.time()
tp = end.time - start.time
print(end.time - start.time)

saveRDS(p1a, "p1a-outcomes-poisson-profile.rds")

print("done profiling, starting confint estimation...")

start.time = Sys.time()

c1a = confint(p1a, verbose=TRUE)

end.time = Sys.time()
tc = end.time - start.time
print(end.time - start.time)

saveRDS(c1a, "c1a-outcomes-poisson-confint.rds")

print(tp)
print(tc)

write(sprintf("Profile time: %s\nConfint time: %s", strftime(tp), strftime(tc)), 
      file = "m1a-timelog.txt", 
      append=TRUE)

# Errors out:
# [1] "starting model profiling..."
# parameter 1:
#   2 2 1.275582 0.9091282 0.2267131 2.685111e-05 0.1129446 0.9404328 0.1706757 1.65161 0.0218103 0.0001340016 -6.046151 -0.05026049
# 3 2 1.850026 0.9183224 0.2267025 5.224517e-06 0.1129316 0.940448 0.1705991 1.65371 0.02188543 0.0001256389 -6.051312 -0.05012146
# 4 2 2.458332 0.9282707 0.2266982 5.241872e-06 0.1128936 0.9408653 0.1703694 1.655654 0.02192912 3.166192e-05 -6.056598 -0.0501784
# 5 2 2.859281 0.9384356 0.2266982 1.032476e-06 0.1128936 0.9408653 0.1703694 1.655654 0.02192912 2.99828e-05 -6.056598 -0.0501784
# 6 2 3.728672 0.9541932 0.2266982 9.702521e-07 0.1128936 0.9408653 0.1703694 1.655654 0.02192912 5.688742e-06 -6.056598 -0.0501784
# 7 2 4.340428 0.9654588 0.2266982 1.822435e-07 0.1128936 0.9408653 0.1703694 1.655654 0.02192912 5.335079e-06 -6.056598 -0.0501784
# 8 2 4.954235 0.9769048 0.2266982 1.701624e-07 0.1128936 0.9408653 0.1703694 1.655654 0.02192912 9.801007e-07 -6.056598 -0.0501784
# 9 2 5.566797 0.9884953 0.228364 6.011241e-08 0.1129183 0.9356087 0.1702155 1.673103 0.02291922 1.013099e-06 -6.074954 -0.0516482
# 2 2 -0.6425107 0.8759542 0.2267573 2.84705e-05 0.1130262 0.9401044 0.171083 1.643988 0.02232477 0.0005196301 -6.028462 -0.05055955
# 3 2 -1.437228 0.864204 0.2268283 2.682803e-05 0.1130076 0.9400452 0.1712052 1.641473 0.02230037 0.0001048605 -6.022093 -0.05069604
# 4 2 -2.039139 0.8550141 0.2268216 3.735466e-06 0.1130188 0.940006 0.1713757 1.639649 0.02221287 9.40545e-05 -6.017319 -0.05036862
# 5 2 -2.512074 0.8455243 0.2247456 3.259435e-06 0.1125402 0.9543816 0.1676985 1.659904 0.02135324 0.0001131718 -6.025371 -0.03446133
# 6 2 -3.262214 0.8330523 0.2267996 2.69889e-06 0.113148 0.9404233 0.1714075 1.633455 0.02308227 6.222149e-06 -6.004641 -0.04966983
# 7 2 -3.909339 0.8227183 0.2269546 3.673676e-07 0.113006 0.9415013 0.1717379 1.633166 0.02218766 5.80267e-06 -5.998162 -0.04996
# 8 2 -4.537398 0.8127926 0.2269546 3.602966e-07 0.113006 0.9415013 0.1717379 1.633166 0.02218766 1.338978e-06 -5.998162 -0.04996
# 9 2 -5.165567 0.8029698 0.2269546 9.007415e-08 0.113006 0.9415013 0.1717379 1.633166 0.02218766 1.338978e-06 -5.998162 -0.04996
# parameter 2:
#   old deviance  56904.73 ,
# new deviance  56904.62 ,
# new params  0.887665153483138,0.22911537807209,2.50464008598819e-05,0.112963412090921,0.940170599991358,0.17088691095295,1.64690721236059,0.0215517147479001,4.63878376130315e-05,-6.03580926160037,-0.04976415583
# 1279
# Error in zeta(shiftpar, start = opt[seqpar1][-w]) :
#   profiling detected new, lower deviance (deviance diff = 0.116, tolerance = 1e-09)
# Calls: profile -> profile.merMod -> lapply -> FUN -> zeta
# Execution halted
